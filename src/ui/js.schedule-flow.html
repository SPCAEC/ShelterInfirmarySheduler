<script>
function renderScheduleFlow(container) {
  const { getClientCache, setClientCache, clearClientCache, backBtn } = window.SPCA;
  sectionTitle.textContent = 'Schedule New Appointment';

  // Build simplified flow skeleton
  container.innerHTML = `
    <div id="step-date" class="schedule-step">
      <h2>Select Appointment Date</h2>
      <div class="field">
        <input type="date" id="apptDate" required min="${new Date().toISOString().split('T')[0]}">
      </div>
      <div class="actions">
        <button id="continueDateBtn" class="btn">Continue</button>
      </div>
    </div>

    <div id="step-form" class="schedule-step hidden">
      <h2>Client & Pet Information</h2>
      <div id="formFields"></div>
      <div class="actions">
        <button id="continueBtn" class="btn">Continue</button>
      </div>
    </div>

    <div id="step-confirm" class="schedule-step hidden">
      <div class="spinner"></div>
    </div>
  `;

  const stepDate = container.querySelector('#step-date');
  const stepForm = container.querySelector('#step-form');
  const stepConfirm = container.querySelector('#step-confirm');
  const continueDateBtn = container.querySelector('#continueDateBtn');
  const continueBtn = container.querySelector('#continueBtn');

  let selectedDate = '';

  continueDateBtn.addEventListener('click', () => {
    const input = container.querySelector('#apptDate');
    if (!input.value) {
      alert('Please select an appointment date.');
      return;
    }
    selectedDate = input.value;
    stepDate.classList.add('hidden');
    stepForm.classList.remove('hidden');
    renderFormFields();
    scrollTop();
  });

  function scrollTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ──────────────────────────────
  // Step 2: Client & Pet Form
  // ──────────────────────────────
  function renderFormFields() {
    const f = container.querySelector('#formFields');
    const cached = getClientCache();

    // Keep the full original form from Grant version
    f.innerHTML = `<?!= include('ui/partials/form.client-pet.html'); ?>`;
    // ^ optional include if you have the form split — if not, paste your full field HTML here

    // phone formatting, vaccine list, and additional services (same as before)
    const phoneInput = f.querySelector('#phone');
    phoneInput.addEventListener('blur', () => {
      const digits = phoneInput.value.replace(/\D/g, '');
      if (digits.length === 10) {
        phoneInput.value = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      }
    });

    // Populate vaccines dynamically
    const speciesSelect = f.querySelector('#species');
    const vaccineList = f.querySelector('#vaccines');
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) return;
        const lists = { canine: res.canine || [], feline: res.feline || [] };

        const renderVaccines = val => {
          let options = [];
          if (val === 'Canine') options = lists.canine;
          else if (val === 'Feline') options = lists.feline;
          vaccineList.innerHTML = options.length
            ? options.map(v => `
                <label class="radio-option">
                  <input type="checkbox" name="vaccine" value="${v}"> ${v}
                </label>`).join('')
            : `<p style="opacity:.6; margin:0;">— No Vaccines Available —</p>`;
        };

        if (cached['Species']) {
          speciesSelect.value = cached['Species'];
          renderVaccines(cached['Species']);
        }
        speciesSelect.addEventListener('change', () => renderVaccines(speciesSelect.value));
      })
      .apiGetVaccineLists();

    // Additional Services list
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) return;
        const containerEl = f.querySelector('#additionalServices');
        containerEl.innerHTML = res.services.map(s => `
          <label class="radio-option">
            <input type="checkbox" name="service" value="${s}"> ${s}
          </label>`).join('');
      })
      .apiGetAdditionalServices();
  }

  continueBtn.addEventListener('click', showTransportModal);

  // ──────────────────────────────
  // Step 3: Transport & Vet Records Modal
  // ──────────────────────────────
  function showTransportModal() {
    const hasVetRecords = container.querySelector('input[name="hasVetRecords"]:checked')?.value === 'Yes';
    const firstName = container.querySelector('#firstName').value.trim();
    const lastName = container.querySelector('#lastName').value.trim();
    const petName = container.querySelector('#petName').value.trim();
    const clientEmail = container.querySelector('#email').value.trim();

    const modal = document.createElement('div');
    modal.className = 'modal';

    modal.innerHTML = `
      <div class="modal-content">
        <p>Does this client require transportation assistance for this appointment?</p>
        <div class="actions transport-actions">
          <button class="btn transportBtn" data-transport="Yes">Yes</button>
          <button class="btn transportBtn" data-transport="No">No</button>
        </div>
        <hr class="divider">
        ${hasVetRecords ? `
          <p>You indicated the client has previous veterinary records for this pet. 
          You can upload them now, send the client an upload link, or remind yourself later.</p>
          <div class="actions">
            <input type="file" id="recordsUpload" multiple style="display:none;" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            <button id="uploadBtn" class="btn" disabled>Upload Records</button>
            <button id="sendRequestBtn" class="btn secondary" disabled>Send Record Request</button>
            <button id="remindLaterBtn" class="btn tertiary" disabled>Remind Me Later</button>
          </div>
          <div id="uploadList" class="upload-list"></div>
          <div id="modalToast"></div>
        ` : ``}
      </div>`;

    document.body.appendChild(modal);

    // identical modal handling logic from Grant version (upload, send, remind)
    // unchanged except that final call goes to apiSubmitShelterAppointment()

    const setToast = (msg, kind='') => {
      const toast = modal.querySelector('#modalToast');
      if (!toast) return;
      toast.className = kind === 'success' ? 'success-message' : 'error';
      toast.textContent = msg;
      if (kind) setTimeout(() => toast.textContent = '', 3000);
    };

    const transportButtons = modal.querySelectorAll('.transportBtn');
    const enableRecordButtons = () => {
      modal.querySelectorAll('#uploadBtn,#sendRequestBtn,#remindLaterBtn').forEach(b => b && b.removeAttribute('disabled'));
    };
    transportButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        transportButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        modal.dataset.transport = btn.dataset.transport;
        if (!hasVetRecords) {
          modal.remove();
          bookAppointment(btn.dataset.transport);
        } else {
          enableRecordButtons();
        }
      });
    });

    // Upload, send, and remind handlers (identical to original)...
    // they each end by calling bookAppointment(modal.dataset.transport)
    // after success or closing the modal
  }

  // ──────────────────────────────
  // Step 4: Append Appointment
  // ──────────────────────────────
  function bookAppointment(transport) {
    stepForm.classList.add('hidden');
    stepConfirm.classList.remove('hidden');

    const allergies = (container.querySelector('#allergies').value || '').trim() || 'None known';
    const payload = {
      firstName: container.querySelector('#firstName').value.trim(),
      lastName: container.querySelector('#lastName').value.trim(),
      email: container.querySelector('#email').value.trim(),
      phoneNumber: container.querySelector('#phone').value.trim(),
      address: container.querySelector('#address').value.trim(),
      city: container.querySelector('#city').value.trim(),
      state: container.querySelector('#state').value.trim(),
      zipCode: container.querySelector('#zip').value.trim(),
      petName: container.querySelector('#petName').value.trim(),
      species: container.querySelector('#species').value.trim(),
      sex: container.querySelector('#sex').value.trim(),
      spayed: container.querySelector('#altered').value.trim(),
      age: container.querySelector('#age').value.trim(),
      breedOne: container.querySelector('#breedOne').value.trim(),
      breedTwo: container.querySelector('#breedTwo').value.trim(),
      color: container.querySelector('#color').value.trim(),
      colorPattern: container.querySelector('#colorPattern').value.trim(),
      vaccinesNeeded: [...container.querySelectorAll('input[name="vaccine"]:checked')].map(el => el.value).join(', '),
      additionalServices: [...container.querySelectorAll('input[name="service"]:checked')].map(el => el.value).join(', '),
      allergies: allergies,
      weight: container.querySelector('#weight').value.trim(),
      notes: container.querySelector('#notes').value.trim(),
      previousVetRecords: container.querySelector('input[name="hasVetRecords"]:checked')?.value || 'No',
      vetOffice: container.querySelector('#vetOffice').value.trim(),
      transportationNeeded: (transport === 'Yes' ? 'Yes' : 'No'),
      date: selectedDate
    };

    setClientCache({
      'First Name': payload.firstName,
      'Last Name': payload.lastName,
      'Email': payload.email,
      'Phone Number': payload.phoneNumber,
      'Address': payload.address,
      'City': payload.city,
      'State': payload.state,
      'Zip Code': payload.zipCode,
      'Species': payload.species
    });

    console.log('Submitting Shelter-Side appointment payload:', payload);

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          stepConfirm.innerHTML = `<p class="error">Error: ${res?.error || 'Submission failed.'}</p>`;
          return;
        }
        showConfirmation();
      })
      .withFailureHandler(err => {
        console.error('Submission failed:', err);
        stepConfirm.innerHTML = `<p class="error">Server error submitting appointment.</p>`;
      })
      .apiSubmitShelterAppointment(payload);
  }

  function showConfirmation() {
    stepConfirm.innerHTML = `
      <h2>Appointment Added!</h2>
      <div class="actions">
        <button id="bookAnotherBtn" class="btn">Book another appointment for this client</button>
        <button id="doneBtn" class="btn secondary">Done</button>
      </div>
    `;
    container.querySelector('#bookAnotherBtn').addEventListener('click', () => {
      renderScheduleFlow(container);
      scrollTop();
    });
    container.querySelector('#doneBtn').addEventListener('click', () => {
      clearClientCache();
      backBtn.click();
    });
  }
}
</script>